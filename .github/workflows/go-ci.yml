name: Go CI/CD

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}

    steps:
    # 1ï¸âƒ£ Checkout code
    - name: Checkout code
      uses: actions/checkout@v4

    # 2ï¸âƒ£ Setup Go
    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: "1.22"
        check-latest: true
        cache: true

    # 3ï¸âƒ£ Install dependencies
    - name: Install dependencies
      run: go mod download

    # 4ï¸âƒ£ Run tests
    - name: Run tests
      run: go test ./... -v || echo "âš ï¸ No tests found"

    # 5ï¸âƒ£ Build Go binary
    - name: Build App
      run: go build -o ums-backend main.go

    # 6ï¸âƒ£ Ensure Build Output
    - name: Verify Build
      run: |
        if [ -f "ums-backend" ]; then
          echo "âœ… Build successful!"
          ls -lh ums-backend
        else
          echo "âŒ Build failed - binary not found"
          exit 1
        fi

    # 7ï¸âƒ£ Build Docker Image
    - name: Build Docker Image
      run: docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/ums-backend:latest .

    # 8ï¸âƒ£ Login to DockerHub
    - name: DockerHub Login
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    # 9ï¸âƒ£ Push Docker Image
    - name: Push Docker Image
      run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/ums-backend:latest

    # ğŸ”Ÿ Deploy Render Service
    - name: Deploy to Render
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        if [ -z "$RENDER_DEPLOY_HOOK" ]; then
          echo "âŒ RENDER_DEPLOY_HOOK secret not configured. Deployment aborted."
          exit 1
        fi

        echo "ğŸš€ Triggering Render Deployment..."
        curl -X POST "$RENDER_DEPLOY_HOOK"
        echo "ğŸ¯ Deploy triggered successfully!"

    # 1ï¸âƒ£1ï¸âƒ£ Done!
    - name: Deployment Info
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ‰ CI/CD Pipeline Completed"
        echo "ğŸ³ Docker â†’ Image Published"
        echo "â˜ï¸ Render â†’ Deploy Triggered"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
